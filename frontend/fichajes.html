<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fichajes</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- Leaflet (mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    .center { display:flex; align-items:center; justify-content:center; }
    #map { width: 100%; height: 360px; border-radius: 12px; border:1px solid var(--border); }
    .big-btn { font-size: 18px; padding: 14px 18px; border-radius: 12px; }
    .log-wrap { margin-top: 16px; }
    .muted-small { font-size:12px; color: var(--muted); }
    .icon { font-size: 22px; margin-right: 8px; }
  </style>
</head>
<body>

  <main class="container">
    <section class="hero">
      <h1 class="title">Fichajes</h1>
      <p class="subtitle">Pulsa el botón para registrar tu posición con fecha y hora. Se mostrará un mapa con tu ubicación.</p>
    </section>

    <div class="card" style="margin-bottom:14px;">
      <div class="center">
        <button id="btnFichar" class="btn big-btn">
          <span class="icon">📍</span>
          Fichar ahora
        </button>
      </div>
      <div id="status" class="status muted-small" style="text-align:center; margin-top:10px;"></div>
    </div>

    <div class="grid">
      <div class="col-6">
        <div class="card">
          <h2>Mapa (ubicación actual)</h2>
          <div id="map"></div>
          <div id="locationInfo" class="muted-small" style="margin-top:8px;"></div>
        </div>
      </div>
      <div class="col-6">
        <div class="card log-wrap">
          <h2>Registro local</h2>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Hora</th>
                  <th>Usuario</th>
                  <th>Lat</th>
                  <th>Lng</th>
                  <th>±m</th>
                </tr>
              </thead>
              <tbody id="logBody"></tbody>
            </table>
          </div>
          <div class="muted-small" style="margin-top:6px;">
            Los fichajes se guardan también en tu navegador (localStorage) para consulta rápida.
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="app.js"></script>
  <script>
    /* ===== Utilidades comunes / auth ===== */
    const API = 'http://localhost:3000/api';
    function getToken(){ try { return localStorage.getItem('token') || ''; } catch { return ''; } }
    function authHeaders(){ const h={'Content-Type':'application/json'}; const t=getToken(); if(t) h['Authorization'] = `Bearer ${t}`; return h; }

    function decodeUser(){
      try{ const r = localStorage.getItem('user'); if (r) return JSON.parse(r); }catch{}
      try{
        const t = getToken(); if (!t || !t.includes('.')) return null;
        const b = t.split('.')[0].replace(/-/g,'+').replace(/_/g,'/');
        const pad = b.length % 4 === 2 ? '==' : b.length % 4 === 3 ? '=' : b.length % 4 === 1 ? '===' : '';
        return JSON.parse(atob(b+pad));
      }catch{ return null; }
    }
    function uidOf(u){ const n = Number(u?.uid || u?.id_usuario || u?.id || u?.ID); return Number.isFinite(n)?n:null; }

    function showStatus(msg, ok=true){ const s=document.getElementById('status'); s.textContent = msg||''; s.className = 'status muted-small ' + (ok?'ok':'err'); }

    // Fecha/hora locales legibles
    function fmtDate(ts){ const d=new Date(ts); return d.toLocaleDateString(); }
    function fmtTime(ts){ const d=new Date(ts); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'}); }

    /* ===== Estado ===== */
    const state = {
      me: null,
      map: null,
      marker: null,
      log: [], // {ts, usuario, lat, lng, acc}
    };

    function init(){
      state.me = decodeUser();
      if (!state.me) { alert('Inicia sesión'); location.href='login.html'; return; }
      loadLocalLog();
      initMap();
      bindEvents();
    }

    /* ===== Mapa (Leaflet) ===== */
    function initMap(){
      // Posición por defecto si aún no hay GPS
      state.map = L.map('map');
      const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      });
      tiles.addTo(state.map);
      state.map.setView([40.4168, -3.7038], 5); // España a vista general
    }

    function updateMap(lat, lng, acc){
      const pos = [lat, lng];
      if (!state.marker){
        state.marker = L.marker(pos).addTo(state.map);
      } else {
        state.marker.setLatLng(pos);
      }
      const info = `Lat ${lat.toFixed(6)}, Lng ${lng.toFixed(6)} · ±${Math.round(acc)} m`;
      state.marker.bindPopup(info).openPopup();
      state.map.setView(pos, 16);
      document.getElementById('locationInfo').textContent = info;
    }

    /* ===== Fichaje (Geolocalización) ===== */
    function bindEvents(){
      const btn = document.getElementById('btnFichar');
      if (btn) btn.onclick = doCheckIn;
    }

    function doCheckIn(){
      if (!('geolocation' in navigator)){
        showStatus('Este navegador no soporta geolocalización', false);
        return;
      }
      showStatus('Solicitando ubicación...');
      navigator.geolocation.getCurrentPosition(onGeoSuccess, onGeoError, {
        enableHighAccuracy: true,
        timeout: 15000,
        maximumAge: 0
      });
    }

    function onGeoSuccess(pos){
      const { latitude:lat, longitude:lng, accuracy:acc } = pos.coords;
      updateMap(lat, lng, acc);

      const ts = Date.now();
      const usuario = state.me?.nombre || `UID ${uidOf(state.me)}` || 'Usuario';
      const entry = { ts, usuario, lat, lng, acc };
      state.log.unshift(entry);
      persistLocalLog();
      renderLog();
      showStatus('Fichaje registrado');

      // Intento de guardar también en servidor (ajusta endpoint según tu API real)
      try{
        fetch(`${API}/fichajes`, {
          method: 'POST',
          headers: authHeaders(),
          body: JSON.stringify({
            fecha: new Date(ts).toISOString(),
            lat, lng, precision_m: acc
          })
        }).catch(()=>{});
      } catch {}
    }

    function onGeoError(err){
      const code = err?.code;
      const map = {
        1: 'Permiso denegado por el usuario',
        2: 'Posición no disponible',
        3: 'Tiempo de espera agotado'
      };
      showStatus(map[code] || 'No se pudo obtener la ubicación', false);
    }

    /* ===== Registro local (tabla) ===== */
    function loadLocalLog(){
      try{ state.log = JSON.parse(localStorage.getItem('fichajes_log')||'[]'); }catch{ state.log = []; }
      renderLog();
    }
    function persistLocalLog(){
      try{ localStorage.setItem('fichajes_log', JSON.stringify(state.log.slice(0,2000))); }catch{}
    }
    function renderLog(){
      const tb = document.getElementById('logBody');
      tb.innerHTML='';
      for (const e of state.log){
        const tr = document.createElement('tr');
        const d = new Date(e.ts);
        const tds = [fmtDate(e.ts), fmtTime(e.ts), e.usuario, e.lat.toFixed(6), e.lng.toFixed(6), Math.round(e.acc).toString()];
        for (const v of tds){ const td=document.createElement('td'); td.textContent=v; tr.appendChild(td); }
        tb.appendChild(tr);
      }
      if (!state.log.length){
        const tr = document.createElement('tr');
        const td = document.createElement('td'); td.colSpan=6; td.className='muted-small'; td.textContent='Sin datos todavía. Pulsa “Fichar ahora”.'; tr.appendChild(td); tb.appendChild(tr);
      }
    }

    init();
  </script>
</body>
</html>
