<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Editar Tienda - RRHH</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <div class="container nav">
      <a class="brand" href="index.html" aria-label="Inicio">
        <div class="logo" aria-hidden="true"></div>
        <div>RRHH App</div>
      </a>
      <nav class="navlinks" aria-label="NavegaciÃ³n principal">
        <a href="ver-usuarios.html">Usuarios</a>
        <a href="ver-tiendas.html">Tiendas</a>
        <a href="asignar-turnos.html">Turnos</a>
        <a href="calendario-usuario.html">Mi calendario</a>
        <a href="fichajes.html">Fichajes</a>
        <a href="crear-turno.html">Crear turno</a>
      </nav>
      <button class="btn btn-outline" id="btnTheme" title="Cambiar tema"></button>
      <div class="user" id="userBox">
        <span id="userLabel">No autenticado</span>
        <a class="btn btn-outline" href="login.html" id="btnLogin">Entrar</a>
        <button class="btn" id="btnLogout" style="display:none">Salir</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h1 class="title">Editar Tienda</h1>
      <p class="subtitle">Actualiza los datos y asigna el jefe de tienda.</p>
    </section>

    <div class="card">
      <div class="field">
        <label for="tiendaSelect">Selecciona una tienda</label>
        <select id="tiendaSelect">
          <option value="">-- Elegir --</option>
        </select>
        <div class="muted" id="loadingMsg">Cargando tiendas y usuarios...</div>
      </div>
      <div class="divider" style="height:1px;background:var(--border);margin:16px 0;"></div>

      <form id="formTienda" style="display:none">
        <div class="row">
          <div class="field">
            <label for="nombre">Nombre</label>
            <input id="nombre" type="text" required placeholder="Nombre de la tienda" />
          </div>
          <div class="field">
            <label for="direccion">DirecciÃ³n</label>
            <input id="direccion" type="text" placeholder="DirecciÃ³n" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="jefe">Jefe de tienda</label>
            <select id="jefe">
              <option value="">-- Sin jefe asignado --</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button type="button" id="btnReset" class="btn btn-secondary">Descartar</button>
          <button type="submit" class="btn">Guardar cambios</button>
        </div>
        <div id="status" class="status"></div>
      </form>
    </div>
  </main>

  <footer>
    <div class="container foot">
      <div>Â© <span id="y"></span> RRHH App Â· GestiÃ³n interna</div>
      <div>
        <a href="login.html">Iniciar sesiÃ³n</a>
        Â·
        <a href="#" id="goTop">Ir arriba</a>
      </div>
    </div>
  </footer>

  <script src="app.js"></script>
  <script>
    const API_PREFIX = 'http://localhost:3000/api';
    const ENDPOINTS = {
      tiendas: `${API_PREFIX}/tiendas`,
      usuarios: `${API_PREFIX}/usuarios`,
      updateTienda: (id) => `${API_PREFIX}/tiendas/${id}`,
      updateRolUsuario: (id) => `${API_PREFIX}/usuarios/${id}/rol`,
    };

    function authHeaders() {
      const headers = { 'Content-Type': 'application/json' };
      const token = localStorage.getItem('token');
      if (token) headers['Authorization'] = `Bearer ${token}`;
      return headers;
    }

    function requireAdmin() {
      try {
        const token = localStorage.getItem('token') || '';
        if (!token || !token.includes('.')) throw new Error('Sin token');
        const b = token.split('.')[0].replace(/-/g,'+').replace(/_/g,'/');
        const payload = JSON.parse(atob(b));
        const rol = String(payload.rol || '').toLowerCase();
        if (rol !== 'admin' && rol !== 'administrador') throw new Error('No admin');
      } catch (_) {
        alert('Acceso restringido: solo administradores');
        window.location.href = 'login.html';
      }
    }

    async function safeFetch(url, options = {}) {
      const res = await fetch(url, options);
      const isJSON = res.headers.get('content-type')?.includes('application/json');
      const data = isJSON ? await res.json().catch(() => null) : await res.text().catch(() => null);
      if (!res.ok) {
        const message = typeof data === 'string' ? data : (data?.message || JSON.stringify(data));
        throw new Error(message || `Error ${res.status}`);
      }
      return data;
    }

    // Estado
    let tiendas = [];
    let usuarios = [];
    let tiendaActual = null;

    // Helpers
    const el = (id) => document.getElementById(id);
    const tiendaSelect = el('tiendaSelect');
    const form = el('formTienda');
    const statusEl = el('status');

    async function cargarDatos() {
      requireAdmin();
      const loading = el('loadingMsg');
      try {
        const [tiendasRes, usuariosRes] = await Promise.all([
          safeFetch(ENDPOINTS.tiendas, { headers: authHeaders() }),
          safeFetch(ENDPOINTS.usuarios, { headers: authHeaders() }),
        ]);
        tiendas = Array.isArray(tiendasRes) ? tiendasRes : (tiendasRes?.data || []);
        usuarios = Array.isArray(usuariosRes) ? usuariosRes : (usuariosRes?.data || []);

        renderTiendas();
        renderUsuarios();
        if (loading) loading.textContent = 'Listo';
      } catch (err) {
        if (loading) loading.textContent = `Error cargando datos: ${err.message}`;
      }
    }

    function renderTiendas() {
      for (const t of tiendas) {
        const opt = document.createElement('option');
        opt.value = t.id_tienda ?? t.id ?? t.tienda_id ?? t.ID ?? t.Id;
        opt.textContent = t.nombre || t.nombre_tienda || t.name || `Tienda ${opt.value}`;
        opt.dataset.json = JSON.stringify(t);
        tiendaSelect.appendChild(opt);
      }
    }

    function renderUsuarios() {
      const jefeSelect = el('jefe');
      jefeSelect.innerHTML = '<option value="">-- Sin jefe asignado --</option>';
      for (const u of usuarios) {
        const id = u.id_usuario ?? u.id ?? u.usuario_id ?? u.ID ?? u.Id;
        const nombre = [u.nombre, u.apellidos || u.apellido].filter(Boolean).join(' ') || u.email || `Usuario ${id}`;
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = nombre;
        jefeSelect.appendChild(opt);
      }
    }

    function rellenarFormulario(tienda) {
      el('nombre').value = tienda.nombre || tienda.nombre_tienda || tienda.name || '';
      el('direccion').value = tienda.direccion || tienda.address || '';
      const jefeId = tienda.id_jefe || tienda.jefe || tienda.jefeId || '';
      el('jefe').value = jefeId || '';
    }

    tiendaSelect.addEventListener('change', (e) => {
      const id = e.target.value;
      if (!id) {
        form.style.display = 'none';
        tiendaActual = null;
        return;
      }
      const opt = e.target.options[e.target.selectedIndex];
      const json = opt.dataset.json ? JSON.parse(opt.dataset.json) : null;
      tiendaActual = json || tiendas.find(t => (t.id_tienda ?? t.id ?? t.tienda_id ?? t.ID) == id) || { id_tienda: id };
      form.style.display = 'block';
      statusEl.textContent = '';
      rellenarFormulario(tiendaActual);
    });

    el('btnReset').addEventListener('click', () => {
      if (tiendaActual) rellenarFormulario(tiendaActual);
      statusEl.textContent = 'Cambios descartados';
      statusEl.className = 'status';
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!tiendaActual) return;
      const id = tiendaSelect.value;

      const payload = {
        nombre: el('nombre').value.trim(),
        direccion: el('direccion').value.trim() || null,
        id_jefe: el('jefe').value || null,
      };

      try {
        // 1) Actualizar la tienda
        await safeFetch(ENDPOINTS.updateTienda(id), {
          method: 'PUT',
          headers: authHeaders(),
          body: JSON.stringify(payload),
        });

        // 2) Si hay jefe seleccionado, actualizar su rol
        if (payload.id_jefe) {
          try {
            await safeFetch(ENDPOINTS.updateRolUsuario(payload.id_jefe), {
              method: 'PUT',
              headers: authHeaders(),
              body: JSON.stringify({ rol: 'jefe' }),
            });
          } catch (err) {
            // Fallback si no existe endpoint dedicado
            await safeFetch(`${ENDPOINTS.usuarios}/${payload.id_jefe}`, {
              method: 'PUT',
              headers: authHeaders(),
              body: JSON.stringify({ rol: 'jefe' }),
            });
          }
        }

        statusEl.textContent = 'Tienda actualizada correctamente';
        statusEl.className = 'status ok';

      } catch (err) {
        statusEl.textContent = `Error: ${err.message}`;
        statusEl.className = 'status err';
      }
    });

    // Inicio
    cargarDatos();
  </script>
</body>
</html>


