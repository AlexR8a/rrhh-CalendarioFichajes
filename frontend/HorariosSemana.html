<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Semana - Horarios por hora</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .controls { display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:12px; }
    .controls .actions { display:flex; gap:8px; align-items:end; justify-content:flex-end; }
    .timeline-wrap { overflow:auto; border:1px solid var(--border); border-radius:12px; background: var(--bg-soft); }
    .timeline { border-collapse: separate; border-spacing:0; min-width: 900px; width: 100%; }
    .timeline th, .timeline td { border-bottom: 1px solid var(--border); padding: 0; }
    .timeline thead th { position: sticky; top:0; z-index: 2; background: rgba(255,255,255,0.04); font-size:12px; color: var(--muted); height: 38px; }
    .day-col { width: 120px; background: rgba(255,255,255,0.03); font-weight:700; font-size:13px; padding: 0 10px; white-space:nowrap; }
    .hour-col { width: 80px; text-align:center; border-left:1px solid var(--border); }
    .slot { min-height: 52px; padding: 6px; border-left:1px solid var(--border); }
    .slot .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; margin: 2px; background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); font-size:12px; }
    .slot .pill .dot { width:8px; height:8px; border-radius:999px; background: var(--brand-2); box-shadow: 0 0 0 2px rgba(52,211,153,.15); }
    .slot .pill .hrs { color: var(--muted); font-weight:700; font-size:11px; padding-left:4px; }
    .legend-mini { display:flex; gap:8px; flex-wrap:wrap; }
    .legend-mini .badge { padding:4px 8px; border:1px solid var(--border); border-radius:8px; font-size:12px; }
    .totals { display:grid; grid-template-columns: repeat(12, minmax(0, 1fr)); gap:16px; }
    .totals .card { grid-column: span 4; }
    .muted-small { font-size:12px; color: var(--muted); }
    @media (max-width: 900px){
      .controls { grid-template-columns: 1fr; }
      .totals .card { grid-column: span 12; }
    }
  </style>
</head>
<body>
  <main class="container">
    <section class="hero">
      <h1 class="title">Semana - Horarios por hora</h1>
      <p class="subtitle">Vista de cuadrante horario por dias y totales de horas por empleado.</p>
    </section>

    <div class="card" style="margin-bottom:14px;">
      <div class="controls">
        <div class="field">
          <label for="selTienda">Centro de trabajo</label>
          <select id="selTienda"></select>
        </div>
        <div class="field">
          <label for="inpSemana">Semana (cualquier fecha dentro)</label>
          <input type="date" id="inpSemana" />
        </div>
        <div class="field">
          <label for="inpHoras">Rango horario (HH-HH)</label>
          <input id="inpHoras" placeholder="08-22" value="08-22" />
        </div>
        <div class="actions">
          <button class="btn btn-secondary" id="btnPrev"><< Semana anterior</button>
          <button class="btn" id="btnHoy">Hoy</button>
          <button class="btn btn-secondary" id="btnNext">Semana siguiente >></button>
        </div>
      </div>
      <div class="status muted-small" id="statusBox"></div>
    </div>

    <div class="card" style="margin-bottom:14px;">
      <div class="legend-mini" id="legend"></div>
    </div>

    <div class="timeline-wrap" id="timelineWrap">
      <table class="timeline" id="grid"></table>
    </div>

    <section style="margin-top:22px;">
      <h2>Totales por empleado (horas semana)</h2>
      <div class="totals" id="totals"></div>
    </section>
  </main>

  <script src="app.js"></script>
  <script>
    const API = 'http://localhost:3000/api';
    const HOR = API + '/horarios';

    function getToken(){ try { return localStorage.getItem('token') || ''; } catch { return ''; } }
    function authHeaders(){ const h={'Content-Type':'application/json'}; const t=getToken(); if(t) h['Authorization'] = `Bearer ${t}`; return h; }

    function decodeUser(){
      try {
        const userRaw = localStorage.getItem('user');
        if (userRaw) return JSON.parse(userRaw);
      } catch {}
      try {
        const t = getToken(); if (!t || !t.includes('.')) return null;
        const b = t.split('.')[0].replace(/-/g,'+').replace(/_/g,'/');
        const pad = b.length % 4 === 2 ? '==' : b.length % 4 === 3 ? '=' : b.length % 4 === 1 ? '===' : '';
        return JSON.parse(atob(b+pad));
      } catch { return null; }
    }

    function uidOf(u){ const n = Number(u?.uid || u?.id_usuario || u?.id || u?.ID); return Number.isFinite(n) ? n : null; }
    function ymd(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
    function monday(d){ const x = new Date(d); const wd = (x.getDay()+6)%7; x.setDate(x.getDate()-wd); x.setHours(0,0,0,0); return x; }
    function addDays(date, days){ const d=new Date(date); d.setDate(d.getDate()+days); return d; }

    function parseHourRange(str){
      if (!str) return [8,22];
      const match = String(str).trim().match(/^(\d{1,2})[-:](\d{1,2})$/);
      if (!match) return [8,22];
      let a = Math.max(0, Math.min(23, Number(match[1])));
      let b = Math.max(0, Math.min(24, Number(match[2])));
      if (b <= a) b = Math.min(24, a + 1);
      return [a,b];
    }

    function hToLabel(h){ return String(h).padStart(2,'0') + ':00'; }

    function overlapHours(startHHMM, endHHMM, slotHour){
      const sH = +startHHMM.slice(0,2), sM = +startHHMM.slice(3,5);
      const eH = +endHHMM.slice(0,2), eM = +endHHMM.slice(3,5);
      const s = sH + sM/60; const e = eH + eM/60; const a = slotHour; const b = slotHour+1;
      return Math.max(s,a) < Math.min(e,b);
    }

    function getTramos(asignacion){
      const base = Array.isArray(asignacion?.tramos) && asignacion.tramos.length
        ? asignacion.tramos
        : [{ orden: 1, hora_inicio: asignacion?.hora_inicio, hora_fin: asignacion?.hora_fin }];
      return base
        .map((t, idx) => {
          const start = String(t?.hora_inicio || '').slice(0,5);
          const end = String(t?.hora_fin || '').slice(0,5);
          if (!start || !end) return null;
          return { orden: Number(t?.orden) || idx + 1, hora_inicio: start, hora_fin: end };
        })
        .filter(Boolean)
        .sort((a,b)=> (a.orden || 0) - (b.orden || 0));
    }

    function assignmentOverlapsHour(asignacion, hour){
      const tramos = getTramos(asignacion);
      return tramos.some((tramo) => overlapHours(tramo.hora_inicio, tramo.hora_fin, hour));
    }

    function tramoTooltip(asignacion){
      const tramos = getTramos(asignacion);
      if (!tramos.length) return `${asignacion?.hora_inicio || ''}-${asignacion?.hora_fin || ''}`;
      return tramos.map((t, idx) => `Tramo ${idx + 1}: ${t.hora_inicio}-${t.hora_fin}`).join(' | ');
    }

    const state = {
      me: null,
      tiendas: [],
      empleados: [],
      weekStart: monday(new Date()),
      range: [8,22],
      asignaciones: [],
    };

    const selTienda = document.getElementById('selTienda');
    const inpSemana = document.getElementById('inpSemana');
    const inpHoras = document.getElementById('inpHoras');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const btnHoy  = document.getElementById('btnHoy');
    const statusBox = document.getElementById('statusBox');
    const grid = document.getElementById('grid');
    const totalsBox = document.getElementById('totals');
    const legendBox = document.getElementById('legend');

    function showStatus(msg, ok=true){ statusBox.textContent = msg||''; statusBox.className = 'muted-small ' + (ok?'status ok':'status err'); }

    async function init(){
      state.me = decodeUser();
      if (!state.me) { alert('Inicia sesion'); location.href='login.html'; return; }
      await loadTiendas();
      inpSemana.value = ymd(new Date());
      renderLegend();
      bindEvents();
      await refresh();
    }

    async function loadTiendas(){
      try{
        const res = await fetch(`${API}/tiendas`, { headers: authHeaders() });
        state.tiendas = res.ok ? await res.json() : [];
      }catch{ state.tiendas = []; }
      selTienda.innerHTML = '';
      for (const t of state.tiendas){ const o=document.createElement('option'); o.value=t.id_tienda; o.textContent=t.nombre; selTienda.appendChild(o); }
      const rol = String(state.me?.rol||'').toLowerCase();
      const myUid = uidOf(state.me);
      if (rol==='jefe' || rol==='encargado'){
        const mine = state.tiendas.find(t=> Number(t.id_jefe)===Number(myUid));
        if (mine){ selTienda.value = String(mine.id_tienda); selTienda.disabled = true; }
      }
    }

    function bindEvents(){
      selTienda.onchange = refresh;
      inpSemana.onchange = ()=>{ state.weekStart = monday(new Date(inpSemana.value||new Date())); refresh(); };
      inpHoras.onchange = ()=>{ state.range = parseHourRange(inpHoras.value); renderGrid(); };
      btnPrev.onclick = ()=>{ state.weekStart = addDays(state.weekStart, -7); inpSemana.value = ymd(state.weekStart); refresh(); };
      btnNext.onclick = ()=>{ state.weekStart = addDays(state.weekStart, 7);  inpSemana.value = ymd(state.weekStart); refresh(); };
      btnHoy.onclick  = ()=>{ state.weekStart = monday(new Date()); inpSemana.value = ymd(new Date()); refresh(); };
    }

    function renderLegend(){
      legendBox.innerHTML='';
      const tips = [
        'Clic en un nombre para resaltar todas sus franjas',
        'Cada tramo se muestra en su bloque horario correspondiente',
        'Rango horario configurable (ej. 06-23)'
      ];
      for (const t of tips){ const b=document.createElement('span'); b.className='badge'; b.textContent=t; legendBox.appendChild(b); }
    }

    async function refresh(){
      const tienda = selTienda.value;
      if (!tienda){ showStatus('Selecciona un centro', false); return; }
      const startISO = ymd(state.weekStart);
      const endISO = ymd(addDays(state.weekStart, 6));
      showStatus('Cargando semana...');
      try{
        const url = `${HOR}/semana?tienda=${encodeURIComponent(tienda)}&inicio=${encodeURIComponent(startISO)}`;
        const res = await fetch(url, { headers: authHeaders() });
        if (!res.ok){ const j = await res.json().catch(()=>({})); showStatus(j.error||res.statusText, false); return; }
        const json = await res.json();
        state.empleados   = json.empleados   || [];
        state.asignaciones = json.asignaciones || [];
        state.range = parseHourRange(inpHoras.value);
        renderGrid();
        renderTotals();
        showStatus(`Semana ${startISO} a ${endISO}`);
      }catch(err){ showStatus('Error de red al cargar', false); }
    }

    function daysOfWeek(start){ const arr=[]; for(let i=0;i<7;i++){ const d=addDays(start,i); arr.push(ymd(d)); } return arr; }

    function renderGrid(){
      const [H1,H2] = state.range;
      const days = daysOfWeek(state.weekStart);
      grid.innerHTML='';

      const thead = document.createElement('thead');
      const thr = document.createElement('tr');
      const th0 = document.createElement('th'); th0.className='day-col'; th0.textContent='Dia'; thr.appendChild(th0);
      for (let h=H1; h<H2; h++){ const th=document.createElement('th'); th.className='hour-col'; th.textContent=hToLabel(h); thr.appendChild(th); }
      thead.appendChild(thr); grid.appendChild(thead);

      const tbody = document.createElement('tbody');
      const byDay = new Map();
      for (const a of state.asignaciones){ if (!byDay.has(a.fecha)) byDay.set(a.fecha, []); byDay.get(a.fecha).push(a); }

      for (const iso of days){
        const tr = document.createElement('tr');
        const tdDay = document.createElement('td'); tdDay.className='day-col';
        tdDay.innerHTML = `<div><strong>${toESDayLabel(iso)}</strong><div class="muted-small">${iso}</div></div>`;
        tr.appendChild(tdDay);
        for (let h=H1; h<H2; h++){
          const td = document.createElement('td'); td.className='slot';
          const list = (byDay.get(iso)||[]).filter(a => assignmentOverlapsHour(a, h));
          list.sort((a,b)=> a.nombre.localeCompare(b.nombre));
          for (const a of list){
            const pill = document.createElement('span');
            pill.className='pill';
            pill.dataset.emp = String(a.id_trabajador);
            const tramos = getTramos(a);
            pill.title = `${a.nombre} -> ${tramoTooltip(a)}`;
            const dot = document.createElement('span');
            dot.className='dot';
            dot.setAttribute('aria-hidden','true');
            const name = document.createElement('span');
            name.textContent = a.nombre;
            pill.appendChild(dot);
            pill.appendChild(name);
            if (tramos.length > 1){
              const badge = document.createElement('span');
              badge.className='hrs';
              badge.textContent = `${tramos.length} tramos`;
              pill.appendChild(badge);
            }
            pill.onclick = ()=> toggleHighlightEmployee(a.id_trabajador);
            td.appendChild(pill);
          }
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      grid.appendChild(tbody);
    }

    function toESDayLabel(iso){
      const d = new Date(iso+'T00:00:00');
      const L = ['Lun','Mar','Mie','Jue','Vie','Sab','Dom'];
      const i = (d.getDay()+6)%7;
      return `${L[i]}`;
    }

    function toggleHighlightEmployee(empId){
      const pills = document.querySelectorAll(`.pill`);
      const on = !document.body.classList.contains('hl-'+empId);
      document.body.className = document.body.className.replace(/\bhl-\d+\b/g,'').trim();
      if (on){ document.body.classList.add('hl-'+empId); }
      pills.forEach(p=>{
        const is = String(p.dataset.emp)===String(empId);
        p.style.filter = (on && !is) ? 'grayscale(1) opacity(0.5)' : '';
        p.style.outline = (on && is) ? '2px solid var(--brand-2)' : '';
      });
    }

    function renderTotals(){
      totalsBox.innerHTML='';
      const map = new Map();
      for (const a of state.asignaciones){
        const tramos = getTramos(a);
        if (!tramos.length) continue;
        if (!map.has(a.id_trabajador)){
          map.set(a.id_trabajador, { nombre: a.nombre, horas: 0, porDia: new Map() });
        }
        const info = map.get(a.id_trabajador);
        for (const tramo of tramos){
          const startMin = toMinutes(tramo.hora_inicio);
          const endMin = toMinutes(tramo.hora_fin);
          if (startMin === null || endMin === null) continue;
          let hours = (endMin - startMin) / 60;
          if (hours <= 0) hours += 24;
          info.horas += hours;
          const current = info.porDia.get(a.fecha) || 0;
          info.porDia.set(a.fecha, current + hours);
        }
      }
      const sorted = [...map.entries()].sort((a,b)=> b[1].horas - a[1].horas);
      for (const [id, info] of sorted){
        const card = document.createElement('div'); card.className='card';
        const h = document.createElement('div'); h.className='title'; h.style.fontSize='18px'; h.textContent = info.nombre; card.appendChild(h);
        const p = document.createElement('div'); p.className='muted'; p.textContent = `${info.horas.toFixed(2)} h`; card.appendChild(p);
        const ul = document.createElement('ul'); ul.className='muted-small'; ul.style.marginTop='8px';
        const entries = [...info.porDia.entries()].sort((a,b)=> a[0].localeCompare(b[0]));
        for (const [fecha, horasDia] of entries){
          const li = document.createElement('li');
          li.textContent = `${fecha} - ${horasDia.toFixed(2)} h`;
          ul.appendChild(li);
        }
        card.appendChild(ul);
        card.onclick = ()=> toggleHighlightEmployee(id);
        totalsBox.appendChild(card);
      }
      if (!sorted.length){
        const empty = document.createElement('div'); empty.className='muted'; empty.textContent='Sin asignaciones en esta semana.'; totalsBox.appendChild(empty);
      }
    }
    init();
  </script>
</body>
</html>



