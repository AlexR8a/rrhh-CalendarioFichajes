<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Asignar Turnos - Semana</title>
  <style>
    table, th, td { border: 1px solid #000; border-collapse: collapse; padding: 5px; vertical-align: top; min-width: 160px; }
    th { background: #eee; }
    .asignado { background: #a4d4a4; margin: 2px 0; padding: 2px 5px; cursor: pointer; }
    .muted { color: #666; font-size: 12px; }
    .warn { color: #b45309; font-size: 12px; }
    .cell-head { display: flex; align-items: center; gap: 6px; }
    .cell-head small { margin-left: 6px; }
  </style>
</head>
<body>
  <h1>Asignar Turnos - Semana</h1>
  <label for="selectTienda">Tienda:</label>
  <select id="selectTienda"></select>
  <button id="btnSemanaAnt">Semana anterior</button>
  <button id="btnSemanaSig">Semana siguiente</button>
  <br /><br />

  <table id="tablaTurnos">
    <thead>
      <tr id="headerDias"></tr>
    </thead>
    <tbody id="bodyTurnos"></tbody>
  </table>

  <script>
    // Calcular lunes de la semana en horario local (evita off-by-one)
    let semanaInicio = new Date();
    semanaInicio.setHours(0,0,0,0);
    const dow = semanaInicio.getDay(); // 0..6 (domingo..sábado)
    const offset = (dow + 6) % 7;      // 0 para lunes, 1 para martes, ... 6 para domingo
    semanaInicio.setDate(semanaInicio.getDate() - offset);

    let tiendas = [];
    let turnos = [];
    let asignaciones = [];
    let fechasSemana = [];
    let trabajadores = [];
    let requerimientos = [];

    const API = 'http://localhost:3000/api';

    function getToken() { return localStorage.getItem('token') || ''; }
    function decodePayload() {
      try {
        const t = getToken();
        if (!t || !t.includes('.')) return null;
        const b = t.split('.')[0].replace(/-/g,'+').replace(/_/g,'/');
        const json = atob(b);
        return JSON.parse(json);
      } catch { return null; }
    }
    function authHeaders() {
      const token = getToken();
      const h = { 'Content-Type': 'application/json' };
      if (token) h['Authorization'] = `Bearer ${token}`;
      return h;
    }

    async function cargarTiendas() {
      const res = await fetch(`${API}/tiendas`);
      tiendas = await res.json();
      console.log('[asignar] tiendas cargadas:', tiendas);
      const select = document.getElementById('selectTienda');
      select.innerHTML = '';
      tiendas.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id_tienda;
        opt.textContent = t.nombre;
        select.appendChild(opt);
      });
      // Si es jefe, seleccionar automáticamente su tienda y bloquear el selector
      const me = decodePayload();
      if (!me || me.rol !== 'jefe') {
        alert('Acceso restringido: solo jefes de tienda');
        window.location.href = 'login.html';
        return;
      }
      const mine = tiendas.find(t => Number(t.id_jefe) === Number(me.uid));
      if (!mine) {
        alert('No tienes una tienda asignada como jefe. Contacta con un administrador.');
        return;
      }
      select.value = String(mine.id_tienda);
      select.disabled = true;
      if (tiendas.length) cargarDatosSemana();
    }

    function fISO(date) { return date.toISOString().slice(0,10); }

    async function cargarDatosSemana() {
      const tiendaId = document.getElementById('selectTienda').value;
      const semanaISO = fISO(semanaInicio);
      console.log('[asignar] cargarDatosSemana tiendaId, semanaISO:', tiendaId, semanaISO);

      const [turnosRes, asignacionesRes, trabajadoresRes, reqRes] = await Promise.all([
        fetch(`${API}/turnos/tienda/${tiendaId}`, { headers: authHeaders() }).then(r => r.json()),
        fetch(`${API}/turnos/asignaciones?id_tienda=${tiendaId}&semana_inicio=${semanaISO}`, { headers: authHeaders() }).then(r => r.json()).then(d => { fechasSemana = d.fechas; return d.asignaciones; }),
        fetch(`${API}/turnos/trabajadores/${tiendaId}`, { headers: authHeaders() }).then(r => r.json()),
        fetch(`${API}/turnos/requerimientos?id_tienda=${tiendaId}&semana_inicio=${semanaISO}`, { headers: authHeaders() }).then(r => r.json()),
      ]);

      turnos = turnosRes;
      // Normaliza asignaciones (tipos y formato de fecha)
      asignaciones = (asignacionesRes || []).map(a => ({
        ...a,
        id_turno: Number(a.id_turno),
        id_trabajador: Number(a.id_trabajador),
        fecha: (typeof a.fecha === 'string') ? a.fecha.slice(0,10) : new Date(a.fecha).toISOString().slice(0,10)
      }));
      trabajadores = trabajadoresRes;
      // Normaliza requerimientos para evitar desajustes de tipos
      requerimientos = (reqRes.requerimientos || []).map(r => ({
        id_turno: Number(r.id_turno),
        fecha: (typeof r.fecha === 'string') ? r.fecha.slice(0,10) : new Date(r.fecha).toISOString().slice(0,10),
        cantidad: Number(r.cantidad)
      }));
      console.log('[asignar] datos semana:', { turnos, asignaciones, trabajadores, requerimientos, fechasSemana });

      renderizarTabla();
    }

    function renderizarTabla() {
      console.log('[asignar] renderizarTabla: turnos=', turnos?.length, 'fechas=', fechasSemana?.length);
      // Cabecera días
      const header = document.getElementById('headerDias');
      header.innerHTML = '<th>Turno / Día</th>';
      fechasSemana.forEach(fecha => {
        const [yy, mm, dd] = String(fecha).split('-').map(Number);
        const d = new Date(yy, (mm || 1) - 1, dd || 1);
        header.innerHTML += `<th>${d.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' })}</th>`;
      });

      // Corrige encabezados usando fecha local para evitar desfases
      {
        let headerRow = '<th>Turno / Día</th>';
        fechasSemana.forEach(fecha => {
          const [yy, mm, dd] = String(fecha).split('-').map(Number);
          const d = new Date(yy, (mm || 1) - 1, dd || 1);
          headerRow += `<th>${d.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' })}</th>`;
        });
        header.innerHTML = headerRow;
      }
      // Cuerpo turnos
      const tbody = document.getElementById('bodyTurnos');
      tbody.innerHTML = '';

      turnos.forEach(turno => {
        const turnoId = Number(turno.id_turno ?? turno.id);
        console.log('[asignar] render turnoId=', turnoId, 'rango=', turno.hora_inicio, turno.hora_fin);
        let fila = `<tr><td>${turno.nombre || 'Turno ' + turnoId}<br>${turno.hora_inicio} - ${turno.hora_fin}</td>`;

        fechasSemana.forEach(fecha => {
          const asignsDia = asignaciones.filter(a => a.id_turno === turnoId && a.fecha === fecha);
          const req = requerimientos.find(r => r.id_turno === turnoId && r.fecha === fecha);
          const cantidadReq = req ? req.cantidad : 0;
          const asignadosCount = asignsDia.length;
          const disableSelect = (!cantidadReq || asignadosCount >= cantidadReq);
          console.log('[asignar] celda', { turnoId, fecha, cantidadReq, asignadosCount, disableSelect });

          const trabajadoresAsignadosHTML = asignsDia.map(a => {
            const trabajador = trabajadores.find(t => t.id_trabajador === a.id_trabajador);
            return `<div class="asignado" data-id="${a.id_asignacion}" title="Click para quitar">${trabajador ? trabajador.nombre : 'Desconocido'}</div>`;
          }).join('');

          fila += `<td data-fecha="${fecha}" data-turno="${turnoId}">
            <div class="cell-head">
              <label>Necesarios: <input type="number" min="1" class="inputCantidad" value="${Math.max(cantidadReq,1)}" style="width:60px;"></label>
              <button class="btnGuardarCantidad">Guardar</button>
              <small class="muted">Asignados: ${asignadosCount}/${cantidadReq || 0}</small>
            </div>
            ${trabajadoresAsignadosHTML}
            <br>
            <select class="selectTrabajador" ${disableSelect ? 'disabled title="Define y guarda la cantidad requerida primero"' : ''}>
              <option value="">-- Añadir trabajador --</option>
              ${trabajadores.map(t => `<option value="${t.id_trabajador}">${t.nombre}</option>`).join('')}
            </select>
            ${disableSelect ? '<div class="warn">Primero guarda la cantidad requerida y/o no superes el máximo.</div>' : ''}
          </td>`;
        });

        fila += '</tr>';
        tbody.innerHTML += fila;
      });

      // Quitar asignación
      document.querySelectorAll('.asignado').forEach(div => {
        div.onclick = async () => {
          if (confirm('¿Quitar esta asignación?')) {
            const id_asignacion = div.getAttribute('data-id');
            console.log('[asignar] desasignar click id_asignacion=', id_asignacion);
            try {
              const res = await fetch(`${API}/turnos/desasignar`, {
                method: 'POST',
                headers: authHeaders(),
                body: JSON.stringify({ id_asignacion })
              });
              const json = await res.json().catch(() => ({}));
              console.log('[asignar] desasignar respuesta', res.status, json);
              if (!res.ok) alert('Error al desasignar: ' + (json.error || res.statusText));
              cargarDatosSemana();
            } catch (e) { alert('Error de red al desasignar'); }
          }
        };
      });

      // Deshabilitar select tras cambios en cantidad hasta guardar
      document.querySelectorAll('.inputCantidad').forEach(inp => {
        inp.addEventListener('input', () => {
          const td = inp.closest('td');
          const sel = td && td.querySelector('.selectTrabajador');
          if (sel) { sel.disabled = true; sel.title = 'Guarda la cantidad para habilitar las asignaciones'; }
          console.log('[asignar] cambio cantidad (requiere guardar):', inp.value, 'td turno=', td?.getAttribute('data-turno'), 'fecha=', td?.getAttribute('data-fecha'));
        });
      });

      // Guardar cantidad requerida
      document.querySelectorAll('.btnGuardarCantidad').forEach(btn => {
        btn.onclick = async () => {
          const td = btn.closest('td');
          const id_turno = parseInt(td.getAttribute('data-turno'), 10);
          const fecha = td.getAttribute('data-fecha');
          const cantidad = parseInt(td.querySelector('.inputCantidad').value, 10);
          console.log('[asignar] guardar cantidad payload:', { id_turno, fecha, cantidad });
          if (isNaN(cantidad) || cantidad < 1) { alert('La cantidad debe ser al menos 1'); return; }
          const res = await fetch(`${API}/turnos/requerimientos`, {
            method: 'POST', headers: authHeaders(), body: JSON.stringify({ id_turno, fecha, cantidad })
          });
          const json = await res.json();
          console.log('[asignar] guardar cantidad respuesta:', res.status, json);
          if (json.error) { alert('Error: ' + json.error); } else { cargarDatosSemana(); }
        };
      });

      // Asignar trabajador (requiere cantidad guardada y cupo disponible)
      document.querySelectorAll('.selectTrabajador').forEach(select => {
        select.onchange = async () => {
          const id_trabajador = select.value; if (!id_trabajador) return;
          const td = select.closest('td');
          const fecha = td.getAttribute('data-fecha');
          const id_turno = parseInt(td.getAttribute('data-turno'), 10);
          // Opcional: id del usuario autenticado que asigna
          let asignado_por = null;
          try {
            const raw = localStorage.getItem('token');
            if (raw && raw.includes('.')) {
              const body = atob(raw.split('.')[0].replace(/-/g,'+').replace(/_/g,'/'));
              const payload = JSON.parse(body);
              if (payload && payload.uid) asignado_por = payload.uid;
            }
          } catch (_) {}
          console.log('[asignar] asignar trabajador payload:', { id_trabajador, id_turno, fecha, asignado_por });
          try {
            const payload = { id_trabajador, id_turno, fecha };
            if (asignado_por) payload.asignado_por = asignado_por;
            const res = await fetch(`${API}/turnos/asignar`, {
              method: 'POST', headers: authHeaders(), body: JSON.stringify(payload)
            });
            const json = await res.json().catch(() => ({}));
            console.log('[asignar] asignar respuesta:', res.status, json);
            if (!res.ok) { alert('Error al asignar: ' + (json.error || res.statusText)); select.value = ''; return; }
            cargarDatosSemana();
          } catch (e) { alert('Error de red al asignar'); }
        };
      });
    }

    document.getElementById('selectTienda').onchange = cargarDatosSemana;
    document.getElementById('btnSemanaAnt').onclick = () => { semanaInicio.setDate(semanaInicio.getDate() - 7); cargarDatosSemana(); };
    document.getElementById('btnSemanaSig').onclick = () => { semanaInicio.setDate(semanaInicio.getDate() + 7); cargarDatosSemana(); };

    cargarTiendas();
  </script>
</body>
</html>
