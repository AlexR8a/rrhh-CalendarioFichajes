<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Planificacion Anual</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .months { display: grid; gap: 12px; }
    .month { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: var(--bg-soft); }
    .month > .head { padding: 12px 14px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .month > .head h3 { margin: 0; font-size: 16px; font-weight: 800; }
    .month > .body { display: none; padding: 12px 14px; }
    .month.expanded > .body { display: block; }
    .week { border: 1px solid var(--border); border-radius: 10px; margin: 12px 0; overflow: hidden; }
    .week .w-head { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: rgba(255,255,255,0.04); }
    .week .w-title { font-weight: 700; color: var(--muted); }
    .legend { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .code-badge { display:inline-block; padding:2px 6px; border-radius:6px; border:1px solid var(--border); font-weight:700; font-size:12px; }
    .w-actions { display:flex; gap:8px; align-items:center; }
    .table-wrap { margin: 0; }
    .week table { width: 100%; border-collapse: collapse; }
    .week th, .week td { padding: 8px; border-bottom: 1px solid var(--border); }
    .week th { font-size: 12px; color: var(--muted); }
    .cell-sel { width: 110px; }
    .muted-small { font-size: 12px; color: var(--muted); }
  </style>
  <script>
    const API = 'http://localhost:3000/api';
    const PLAN = API + '/planificacion';

    function getToken(){ try { return localStorage.getItem('token') || ''; } catch { return ''; } }
    function authHeaders(){ const h={'Content-Type':'application/json'}; const t=getToken(); if(t) h['Authorization'] = `Bearer ${t}`; return h; }
    function decodeUser(){
      try {
        const userRaw = localStorage.getItem('user');
        if (userRaw) return JSON.parse(userRaw);
      } catch {}
      try {
        const t = getToken(); if (!t || !t.includes('.')) return null;
        const b = t.split('.')[0].replace(/-/g,'+').replace(/_/g,'/');
        const pad = b.length % 4 === 2 ? '==' : b.length % 4 === 3 ? '=' : b.length % 4 === 1 ? '===' : '';
        return JSON.parse(atob(b+pad));
      } catch { return null; }
    }
    function uidOf(u){ const n = Number(u?.uid || u?.id_usuario || u?.id || u?.ID); return Number.isFinite(n) ? n : null; }
    function ymd(d){
      // Fecha local YYYY-MM-DD sin usar toISOString (evita desfases por zona horaria)
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }
    function monday(d){ const x = new Date(d); const wd = (x.getDay()+6)%7; x.setDate(x.getDate()-wd); x.setHours(0,0,0,0); return x; }
    function weeksOfMonth(year, month){
      const first = new Date(year, month, 1);
      const last = new Date(year, month+1, 0);
      const start = monday(first);
      const weeks = [];
      let cur = new Date(start);
      while (cur <= last || (cur.getMonth()===month && cur.getDate()===1)){ // cubre semanas colindantes
        const days = [];
        for (let i=0;i<7;i++){ const d = new Date(cur); d.setDate(cur.getDate()+i); days.push(ymd(d)); }
        // Comprueba si alguna fecha de la semana pertenece al mes objetivo
        const inMonth = days.some(iso => { const [Y,M,D]=iso.split('-').map(Number); return (M-1)===month; });
        if (!inMonth && weeks.length){
          // si ya no toca el mes, finaliza
          break;
        }
        weeks.push({ start: ymd(cur), days });
        cur.setDate(cur.getDate()+7);
      }
      return weeks;
    }
  </script>
</head>
<body>
  

  <main class="container">
    <section class="hero">
      <h1 class="title">Planificacion anual</h1>
      <p class="subtitle">Trabaja por meses y semanas. Copia y pega la configuracion semanal.</p>
    </section>

    <div class="card" style="margin-bottom:14px;">
      <div class="row" style="grid-template-columns: 1fr 180px; align-items: end;">
        <div class="field">
          <label for="selTienda">Centro de trabajo</label>
          <select id="selTienda"></select>
        </div>
        <div class="field">
          <label for="selAnio">Anio</label>
          <select id="selAnio"></select>
        </div>
      </div>
      <div class="muted-small" id="statusBox"></div>
    </div>

    <div class="card" style="margin-bottom:14px;">
      <div class="legend" id="legend"></div>
    </div>

    <div id="months" class="months"></div>
  </main>

  

  <script src="app.js"></script>
  <script>
    const selTienda = document.getElementById('selTienda');
    const selAnio = document.getElementById('selAnio');
    const monthsBox = document.getElementById('months');
    const legendBox = document.getElementById('legend');
    const statusBox = document.getElementById('statusBox');

    const state = {
      me: null,
      tiendas: [],
      anios: [],
      empleados: [],
      codigos: [],
      asigMap: new Map(), // key `${id}|${fecha}` -> id_turno_codigo
      codeById: new Map(),
      idByCode: new Map(),
      year: new Date().getFullYear(),
      clipboard: null, // { empleados: { id: [idc,idc,...7] } }
    };

    function showStatus(msg, ok=true){ statusBox.textContent = msg || ''; statusBox.className = 'muted-small ' + (ok?'status ok':'status err'); }

    async function init(){
      state.me = decodeUser();
      if (!state.me) { alert('Inicia sesion'); location.href='login.html'; return; }
      await loadTiendasYAnios();
      await loadData();
      renderLegend();
      renderMonths();
    }

    async function loadTiendasYAnios(){
      try{
        const resT = await fetch(`${API}/tiendas`, { headers: authHeaders() });
        state.tiendas = resT.ok ? await resT.json() : [];
      }catch{ state.tiendas=[]; }
      selTienda.innerHTML='';
      for (const t of state.tiendas){ const o=document.createElement('option'); o.value=t.id_tienda; o.textContent=t.nombre; selTienda.appendChild(o); }
      // auto tienda para jefe/encargado
      const rol = String(state.me?.rol||'').toLowerCase();
      const myUid = uidOf(state.me);
      if (rol==='jefe' || rol==='encargado'){
        const mine = state.tiendas.find(t=> Number(t.id_jefe)===Number(myUid));
        if (mine){ selTienda.value = String(mine.id_tienda); selTienda.disabled = true; }
      }

      try{
        const resA = await fetch(`${PLAN}/anios`);
        state.anios = resA.ok ? await resA.json() : [];
      }catch{ state.anios=[]; }
      if (!state.anios || !state.anios.length) state.anios=[{valor: state.year}];
      selAnio.innerHTML='';
      for (const a of state.anios){ const o=document.createElement('option'); o.value=a.valor; o.textContent=a.valor; selAnio.appendChild(o); }
      selAnio.value = String(state.year);

      selTienda.onchange = async ()=>{ await loadData(); renderLegend(); renderMonths(); };
      selAnio.onchange = async ()=>{ state.year = parseInt(selAnio.value,10)||state.year; await loadData(); renderLegend(); renderMonths(); };
    }

    async function loadData(){
      const tienda = selTienda.value; const y = parseInt(selAnio.value||state.year,10);
      if (!tienda || !y){ showStatus('Selecciona tienda y anio', false); return; }
      showStatus('Cargando datos...', true);
      try{
        const res = await fetch(`${PLAN}/asignaciones?tienda=${encodeURIComponent(tienda)}&anio=${encodeURIComponent(y)}`, { headers: authHeaders() });
        if (!res.ok){ const j=await res.json().catch(()=>({})); showStatus(j.error||res.statusText, false); return; }
        const json = await res.json();
        state.empleados = json.empleados || [];
        state.codigos = json.codigos || [];
        state.asigMap = new Map();
        state.codeById = new Map();
        state.idByCode = new Map();
        for (const c of state.codigos){ state.codeById.set(c.id_turno_codigo, c); state.idByCode.set(String(c.codigo).toUpperCase(), c.id_turno_codigo); }
        for (const a of (json.asignaciones||[])){ state.asigMap.set(`${a.id_trabajador}|${a.fecha}`, a.id_turno_codigo); }
        showStatus('Datos cargados');
      }catch(err){ showStatus('Error de red al cargar', false); }
    }

    function renderLegend(){
      legendBox.innerHTML='';
      for (const c of state.codigos){
        const span=document.createElement('span'); span.className='code-badge'; span.textContent = `${c.codigo} (${Number(c.horas).toFixed(2)}h)`; legendBox.appendChild(span);
      }
      if (!state.codigos.length){ const s=document.createElement('span'); s.className='muted-small'; s.textContent='No hay codigos definidos (usa Gestionar turnos en otra vista)'; legendBox.appendChild(s); }
    }

    function monthName(m){ return ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][m]; }

    function renderMonths(){
      monthsBox.innerHTML='';
      const y = state.year;
      for (let m=0;m<12;m++){
        const weeks = weeksOfMonth(y,m);
        const wrap = document.createElement('div'); wrap.className='month';
        const head = document.createElement('div'); head.className='head';
        const h3 = document.createElement('h3'); h3.textContent = `${monthName(m)} ${y}`; head.appendChild(h3);
        const info = document.createElement('div'); info.className='muted-small'; info.textContent = `${weeks.length} semanas`; head.appendChild(info);
        wrap.appendChild(head);
        const body = document.createElement('div'); body.className='body'; wrap.appendChild(body);
        head.onclick = ()=>{ const exp = wrap.classList.toggle('expanded'); if (exp && !body.hasChildNodes()) { renderWeeks(body, weeks, m); } };
        monthsBox.appendChild(wrap);
      }
    }

    function renderWeeks(container, weeks, month){
      container.innerHTML='';
      for (const W of weeks){ container.appendChild(buildWeek(W, month)); }
    }

    function buildWeek(W, month){
      const box = document.createElement('div'); box.className='week';
      const head = document.createElement('div'); head.className='w-head';
      const t = document.createElement('div'); t.className='w-title'; t.textContent = `Semana ${W.days[0]} a ${W.days[6]}`; head.appendChild(t);
      const actions = document.createElement('div'); actions.className='w-actions';
      const btnCopy = document.createElement('button'); btnCopy.className='btn btn-secondary'; btnCopy.textContent='Copiar semana';
      const btnPaste = document.createElement('button'); btnPaste.className='btn btn-secondary'; btnPaste.textContent='Pegar aqui';
      const btnSave = document.createElement('button'); btnSave.className='btn'; btnSave.textContent='Guardar semana';
      actions.appendChild(btnCopy); actions.appendChild(btnPaste); actions.appendChild(btnSave); head.appendChild(actions);
      box.appendChild(head);

      const tableWrap = document.createElement('div'); tableWrap.className='table-wrap';
      const table = document.createElement('table');
      const thead = document.createElement('thead'); const thr = document.createElement('tr');
      const thEmp = document.createElement('th'); thEmp.textContent='Empleado'; thr.appendChild(thEmp);
      for (const d of ['L','M','X','J','V','S','D']){ const th=document.createElement('th'); th.textContent=d; thr.appendChild(th); }
      thead.appendChild(thr); table.appendChild(thead);
      const tbody = document.createElement('tbody');

      const sels = []; // para recolectar valores
      for (const emp of state.empleados){
        const tr = document.createElement('tr');
        const tdName = document.createElement('td'); tdName.textContent = emp.nombre; tr.appendChild(tdName);
        const rowSels = [];
        for (let i=0;i<7;i++){
          const td = document.createElement('td');
          const sel = document.createElement('select'); sel.className='cell-sel';
          sel.innerHTML = `<option value="">Sin</option>` + state.codigos.map(c=>`<option value="${c.id_turno_codigo}">${c.codigo}</option>`).join('');
          const iso = W.days[i];
          const dt = new Date(iso + 'T00:00:00');
          const inMonth = dt.getMonth() === month && dt.getFullYear() === state.year;
          const key=`${emp.id_trabajador}|${iso}`; const idc=state.asigMap.get(key)||''; sel.value = idc?String(idc):'';
          if (!inMonth) { sel.disabled = true; sel.title = 'Fuera del mes seleccionado'; }
          td.appendChild(sel); tr.appendChild(td); rowSels.push(sel);
        }
        tbody.appendChild(tr); sels.push({ emp, sels: rowSels });
      }
      table.appendChild(tbody); tableWrap.appendChild(table); box.appendChild(tableWrap);

      btnCopy.onclick = ()=>{
        const clip = { empleados: {} };
        for (const r of sels){ clip.empleados[r.emp.id_trabajador] = r.sels.map(s=> s.disabled ? null : (s.value ? parseInt(s.value,10) : null)); }
        state.clipboard = clip; showStatus('Semana copiada');
      };
      btnPaste.onclick = ()=>{
        if (!state.clipboard || !state.clipboard.empleados){ showStatus('No hay semana en el portapapeles', false); return; }
        for (const r of sels){ const arr = state.clipboard.empleados[r.emp.id_trabajador]; if (!arr) continue; for (let i=0;i<7;i++){ const v=arr[i]; if (r.sels[i].disabled) continue; r.sels[i].value = v?String(v):''; } }
        showStatus('Pegado. Pulsa Guardar semana para aplicar.');
      };
      btnSave.onclick = async ()=>{
        const items = [];
        for (const r of sels){
          for (let i=0;i<7;i++){
            const fecha = W.days[i]; const id_trabajador = r.emp.id_trabajador; const val = r.sels[i].value || '';
            if (r.sels[i].disabled) continue; // no guardar fuera del mes/aÃ±o
            const y = parseInt(fecha.slice(0,4),10); if (y !== state.year) continue; // seguridad
            const key = `${id_trabajador}|${fecha}`; const cur = state.asigMap.get(key)||null; const next = val?parseInt(val,10):null;
            if (cur !== next){ items.push({ id_trabajador, fecha, id_turno_codigo: next }); }
          }
        }
        if (!items.length){ showStatus('No hay cambios'); return; }
        try{
          const res = await fetch(`${PLAN}/asignaciones/bulk`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ items }) });
          const ok = res.ok; const j = await res.json().catch(()=>({}));
          if (!ok){ if (res.status===401){ alert('Sesion expirada'); location.href='login.html'; return; } showStatus(j.error||res.statusText, false); return; }
          // Actualizar mapa local y refrescar leyendas/encabezados
          for (const it of items){ const k=`${it.id_trabajador}|${it.fecha}`; if (it.id_turno_codigo) state.asigMap.set(k, it.id_turno_codigo); else state.asigMap.delete(k); }
          const det = j && j.detalles ? ` ${JSON.stringify(j.detalles)}` : '';
          showStatus('Semana guardada' + det);
        }catch(err){ showStatus('Error al guardar', false); }
      };

      return box;
    }

    init();
  </script>
</body>
</html>

