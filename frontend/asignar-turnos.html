<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Asignar Turnos - Semana</title>
  <style>
    table, th, td {
      border: 1px solid black;
      border-collapse: collapse;
      padding: 5px;
      vertical-align: top;
      min-width: 140px;
    }
    th {
      background: #eee;
    }
    .asignado {
      background: #a4d4a4;
      margin: 2px 0;
      padding: 2px 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Asignar Turnos - Semana</h1>
  <label for="selectTienda">Tienda:</label>
  <select id="selectTienda"></select>
  <button id="btnSemanaAnt">Semana anterior</button>
  <button id="btnSemanaSig">Semana siguiente</button>
  <br /><br />
  <table id="tablaTurnos">
    <thead>
      <tr id="headerDias"></tr>
    </thead>
    <tbody id="bodyTurnos"></tbody>
  </table>

  <script>
    let semanaInicio = new Date();
    semanaInicio.setDate(semanaInicio.getDate() - ((semanaInicio.getDay() + 6) % 7)); // lunes actual
    let tiendas = [];
    let turnos = [];
    let asignaciones = [];
    let fechasSemana = [];
    let trabajadores = [];
    let requerimientos = [];

    async function cargarTiendas() {
      const res = await fetch("http://localhost:3000/api/tiendas");
      tiendas = await res.json();
      const select = document.getElementById("selectTienda");
      select.innerHTML = '';
      tiendas.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id_tienda;
        opt.textContent = t.nombre;
        select.appendChild(opt);
      });
      if (tiendas.length) {
        cargarDatosSemana();
      }
    }

    function formatearFecha(date) {
      return date.toISOString().slice(0, 10);
    }

    async function cargarDatosSemana() {
      const tiendaId = document.getElementById("selectTienda").value;
      const semanaISO = formatearFecha(semanaInicio);

      const [turnosRes, asignacionesRes, trabajadoresRes, requerimientosRes] = await Promise.all([
        fetch(`http://localhost:3000/api/turnos/tienda/${tiendaId}`).then(r => r.json()),
        fetch(`http://localhost:3000/api/turnos/asignaciones?id_tienda=${tiendaId}&semana_inicio=${semanaISO}`).then(r => r.json()).then(data => {
          fechasSemana = data.fechas;
          return data.asignaciones;
        }),
        fetch(`http://localhost:3000/api/turnos/trabajadores/${tiendaId}`).then(r => r.json()),
        fetch(`http://localhost:3000/api/turnos/requerimientos?id_tienda=${tiendaId}&semana_inicio=${semanaISO}`).then(r => r.json())
      ]);

      turnos = turnosRes;
      asignaciones = asignacionesRes;
      trabajadores = trabajadoresRes;
      requerimientos = requerimientosRes.requerimientos || [];

      renderizarTabla();
    }

    function renderizarTabla() {
      // Header con días
      const header = document.getElementById("headerDias");
      header.innerHTML = '<th>Turno / Día</th>';
      fechasSemana.forEach(fecha => {
        const d = new Date(fecha);
        header.innerHTML += `<th>${d.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' })}</th>`;
      });

      // Cuerpo con turnos
      const tbody = document.getElementById("bodyTurnos");
      tbody.innerHTML = '';

      turnos.forEach(turno => {
        let fila = `<tr><td>${turno.nombre || 'Turno ' + turno.id_turno}<br>${turno.hora_inicio} - ${turno.hora_fin}</td>`;

        fechasSemana.forEach(fecha => {
          const asignsDia = asignaciones.filter(a => a.id_turno === turno.id_turno && a.fecha === fecha);
          const req = requerimientos.find(r => r.id_turno === turno.id_turno && r.fecha === fecha);
          const cantidadReq = req ? req.cantidad : 0;

          let trabajadoresAsignadosHTML = asignsDia.map(a => {
            const trabajador = trabajadores.find(t => t.id_trabajador === a.id_trabajador);
            return `<div class="asignado" data-id="${a.id_asignacion}" title="Click para quitar">${trabajador ? trabajador.nombre : 'Desconocido'}</div>`;
          }).join('');

          fila += `<td data-fecha="${fecha}" data-turno="${turno.id_turno}">
            <label>Necesarios: <input type="number" min="0" class="inputCantidad" value="${cantidadReq}" style="width:50px;"></label>
            <button class="btnGuardarCantidad">Guardar</button>
            <br>
            ${trabajadoresAsignadosHTML}<br>
            <select class="selectTrabajador">
              <option value="">-- Añadir trabajador --</option>
              ${trabajadores.map(t => `<option value="${t.id_trabajador}">${t.nombre}</option>`).join('')}
            </select>
          </td>`;
        });

        fila += '</tr>';
        tbody.innerHTML += fila;
      });

      // Eventos para quitar asignaciones
      document.querySelectorAll('.asignado').forEach(div => {
        div.onclick = async () => {
          if(confirm('¿Quitar esta asignación?')){
            const id_asignacion = div.getAttribute('data-id');
            await fetch('http://localhost:3000/api/turnos/desasignar', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id_asignacion })
            });
            cargarDatosSemana();
          }
        };
      });

      // Eventos para asignar nuevo trabajador
      document.querySelectorAll('.selectTrabajador').forEach(select => {
        select.onchange = async () => {
          const id_trabajador = select.value;
          if (!id_trabajador) return;
          const td = select.parentElement;
          const fecha = td.getAttribute('data-fecha');
          const id_turno = parseInt(td.getAttribute('data-turno'), 10);

          // Aquí deberías usar el usuario logueado, para demo pongo 1
          const asignado_por = 1;

          await fetch('http://localhost:3000/api/turnos/asignar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id_trabajador, id_turno, fecha, asignado_por })
          });
          cargarDatosSemana();
        };
      });

      // Eventos para guardar cantidad requerida
      document.querySelectorAll('.btnGuardarCantidad').forEach(btn => {
        btn.onclick = async () => {
          const td = btn.parentElement;
          const id_turno = parseInt(td.getAttribute('data-turno'), 10);
          const fecha = td.getAttribute('data-fecha');
          const cantidad = parseInt(td.querySelector('.inputCantidad').value, 10);

          if (isNaN(cantidad) || cantidad < 0) {
            alert('Cantidad inválida');
            return;
          }

          const res = await fetch('http://localhost:3000/api/turnos/requerimientos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id_turno, fecha, cantidad })
          });

          const json = await res.json();
          if(json.error) {
            alert('Error: ' + json.error);
          } else {
            alert('Cantidad guardada');
            cargarDatosSemana();
          }
        };
      });
    }

    document.getElementById("selectTienda").onchange = cargarDatosSemana;
    document.getElementById("btnSemanaAnt").onclick = () => {
      semanaInicio.setDate(semanaInicio.getDate() - 7);
      cargarDatosSemana();
    };
    document.getElementById("btnSemanaSig").onclick = () => {
      semanaInicio.setDate(semanaInicio.getDate() + 7);
      cargarDatosSemana();
    };

    cargarTiendas();
  </script>
</body>
</html>
