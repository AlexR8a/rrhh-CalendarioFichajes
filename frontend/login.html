<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Iniciar sesión - RRHH</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #f7f7fb; margin: 0; }
    header, footer { background: #f5f5f5; border-bottom: 1px solid #ddd; }
    footer { border-top: 1px solid #ddd; border-bottom: 0; margin-top: 24px; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 12px 16px; }
    nav a { margin-right: 10px; }
    main { max-width: 420px; margin: 60px auto; background: #fff; padding: 24px; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    h1 { font-size: 18px; margin-top: 0; }
    label { display: block; margin: 12px 0 6px; font-size: 13px; color: #374151; }
    input { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
    button { margin-top: 16px; width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid transparent; background: #2563eb; color: #fff; font-weight: 600; cursor: pointer; }
    .status { margin-top: 12px; font-size: 13px; color: #991b1b; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <strong>RRHH</strong>
      <nav style="display:inline-block; margin-left:16px;">
        <a href="index.html">Inicio</a>
        <a href="ver-usuarios.html">Usuarios</a>
        <a href="ver-tiendas.html">Tiendas</a>
        <a href="asignar-turnos.html">Asignar turnos</a>
      </nav>
    </div>
  </header>

  <main>
    <h1>Iniciar sesión</h1>
    <form id="formLogin">
      <label for="identificador">Usuario o Email</label>
      <input id="identificador" type="text" placeholder="usuario o correo" required />
      <label for="password">Contraseña</label>
      <input id="password" type="password" placeholder="********" required />
      <button type="submit">Entrar</button>
      <div class="status" id="status"></div>
    </form>

    <form id="formSetPassword" style="display:none; margin-top:16px;">
      <h2>Establecer contraseña</h2>
      <label for="newPass">Nueva contraseña</label>
      <input id="newPass" type="password" placeholder="Mínimo 8 caracteres (letras y números)" />
      <label for="newPass2">Confirmar contraseña</label>
      <input id="newPass2" type="password" placeholder="Repite la contraseña" />
      <button type="button" id="btnSetPass">Guardar contraseña</button>
    </form>
  </main>

  <footer>
    <div class="wrap">
      <small>© <span id="y"></span> RRHH</small>
    </div>
  </footer>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();
    const API = 'http://localhost:3000/api';
    const statusEl = document.getElementById('status');

    let setupToken = null;

    document.getElementById('formLogin').addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = '';
      const identificador = document.getElementById('identificador').value.trim();
      const password = document.getElementById('password').value;
      try {
        const res = await fetch(`${API}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ identificador, password })
        });
        const data = await res.json();
        if (!res.ok) {
          if (data && data.requirePassword && data.setupToken) {
            setupToken = data.setupToken;
            statusEl.textContent = 'Necesitas establecer una contraseña nueva';
            document.getElementById('formSetPassword').style.display = 'block';
            return;
          }
          throw new Error(data.error || 'Error de autenticación');
        }
        localStorage.setItem('token', data.token);
        localStorage.setItem('user', JSON.stringify(data.user));
        window.location.href = 'index.html';
      } catch (err) {
        statusEl.textContent = err.message;
      }
    });

    document.getElementById('btnSetPass').addEventListener('click', async () => {
      const p1 = document.getElementById('newPass').value;
      const p2 = document.getElementById('newPass2').value;
      if (!setupToken) { statusEl.textContent = 'Token de establecimiento no disponible'; return; }
      if (p1 !== p2) { statusEl.textContent = 'Las contraseñas no coinciden'; return; }
      if (p1.length < 8 || !/[A-Za-z]/.test(p1) || !/\d/.test(p1)) {
        statusEl.textContent = 'Mínimo 8 caracteres, con letras y números';
        return;
      }
      try {
        const res = await fetch(`${API}/auth/set-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${setupToken}` },
          body: JSON.stringify({ password: p1, confirm: p2 })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'No se pudo establecer la contraseña');
        statusEl.style.color = 'green';
        statusEl.textContent = 'Contraseña establecida. Ahora inicia sesión.';
        document.getElementById('formSetPassword').style.display = 'none';
      } catch (err) {
        statusEl.textContent = err.message;
      }
    });
  </script>
  
</body>
</html>
