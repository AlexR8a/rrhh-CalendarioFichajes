<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Crear Turno - RRHH</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <div class="container nav">
      <a class="brand" href="index.html" aria-label="Inicio">
        <div class="logo" aria-hidden="true"></div>
        <div>RRHH App</div>
      </a>
      <nav class="navlinks" aria-label="NavegaciÃ³n principal">
        <a href="ver-usuarios.html">Usuarios</a>
        <a href="ver-tiendas.html">Tiendas</a>
        <a href="asignar-turnos.html">Turnos</a>
        <a href="calendario-usuario.html">Mi calendario</a>
        <a href="fichajes.html">Fichajes</a>
        <a href="crear-turno.html">Crear turno</a>
      </nav>
      <button class="btn btn-outline" id="btnTheme" title="Cambiar tema"></button>
      <div class="user" id="userBox">
        <span id="userLabel">No autenticado</span>
        <a class="btn btn-outline" href="login.html" id="btnLogin">Entrar</a>
        <button class="btn" id="btnLogout" style="display:none">Salir</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h1 class="title">Crear Turno para una Tienda</h1>
      <p class="subtitle">Rangos de 30 minutos y mÃ¡ximo 4 horas.</p>
    </section>

    <div class="card">
      <form id="formTurno">
        <label for="tienda">Tienda</label>
        <select id="tienda" required></select>

        

        <label>Hora de inicio</label>
        <div class="row" style="grid-template-columns: 120px 30px 120px; align-items:center;">
          <select id="horaInicioHora" required></select>
          <div class="muted" style="text-align:center;"> :</div>
          <select id="horaInicioMin" required>
            <option value="00">00</option>
            <option value="30">30</option>
          </select>
        </div>

        <label>Hora de fin</label>
        <div class="row" style="grid-template-columns: 120px 30px 120px; align-items:center;">
          <select id="horaFinHora" required></select>
          <div class="muted" style="text-align:center;">:</div>
          <select id="horaFinMin" required>
            <option value="00">00</option>
            <option value="30">30</option>
          </select>
        </div>

        <div class="actions">
          <button type="submit" class="btn">Crear turno</button>
        </div>
      </form>
      <p id="mensaje" class="status"></p>
    </div>
  </main>

  <footer>
    <div class="container foot">
      <div>Â© <span id="y"></span> RRHH App Â· GestiÃ³n interna</div>
      <div>
        <a href="login.html">Iniciar sesiÃ³n</a>
        Â·
        <a href="#" id="goTop">Ir arriba</a>
      </div>
    </div>
  </footer>

  <script src="app.js"></script>
  <script>
    function decodePayload() {
      try {
        const token = localStorage.getItem('token') || '';
        if (!token || !token.includes('.')) return null;
        const b = token.split('.')[0].replace(/-/g,'+').replace(/_/g,'/');
        return JSON.parse(atob(b));
      } catch (_) { return null; }
    }
    function requireAdminOrJefe() {
      const p = decodePayload();
      const rol = String(p?.rol || '').toLowerCase();
      if (rol === 'admin' || rol === 'administrador' || rol === 'jefe') return p;
      alert('Acceso restringido: solo administradores o jefes');
      window.location.href = 'login.html';
    }
    function authHeaders() {
      const h = { 'Content-Type': 'application/json' };
      const t = localStorage.getItem('token');
      if (t) h['Authorization'] = `Bearer ${t}`;
      return h;
    }

    async function cargarDatos() {
      const me = requireAdminOrJefe();
      const tiendas = await fetch('http://localhost:3000/api/tiendas', { headers: authHeaders() }).then(r => r.json());

      const selTienda = document.getElementById('tienda');
      tiendas.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id_tienda;
        opt.textContent = t.nombre;
        selTienda.appendChild(opt);
      });
      // Si es jefe, autoseleccionar y bloquear su tienda
      if (String(me.rol).toLowerCase() === 'jefe') {
        const mine = tiendas.find(t => Number(t.id_jefe) === Number(me.uid));
        if (!mine) {
          alert('No tienes tienda asignada como jefe. Contacta con un administrador.');
        } else {
          selTienda.value = String(mine.id_tienda);
          selTienda.disabled = true;
        }
      }

      
    }

    // Rellenar horas 00..23
    const fillHours = (sel) => {
      for (let h = 0; h < 24; h++) {
        const v = String(h).padStart(2, '0');
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        sel.appendChild(opt);
      }
    };
    const hIni = document.getElementById('horaInicioHora');
    const hFin = document.getElementById('horaFinHora');
    fillHours(hIni); fillHours(hFin);

    document.getElementById('formTurno').onsubmit = async (e) => {
      e.preventDefault();
      const horaInicio = `${document.getElementById('horaInicioHora').value}:${document.getElementById('horaInicioMin').value}`;
      const horaFin = `${document.getElementById('horaFinHora').value}:${document.getElementById('horaFinMin').value}`;

      const toMinutes = (hhmm) => {
        const [hh, mm] = String(hhmm).split(':').map(Number);
        return hh * 60 + mm;
      };
      const start = toMinutes(horaInicio);
      const end = toMinutes(horaFin);
      const isHalfHour = (m) => m % 30 === 0;

      const msgEl = document.getElementById('mensaje');
      const error = (m) => { msgEl.textContent = 'Error: ' + m; msgEl.className = 'status err'; };
      const ok = (m) => { msgEl.textContent = m; msgEl.className = 'status ok'; };

      if (!isHalfHour(start) || !isHalfHour(end)) {
        return error('Las horas deben estar en intervalos de 30 minutos.');
      }
      const duration = end - start;
      if (duration <= 0) {
        return error('La hora de fin debe ser posterior a la de inicio.');
      }
      if (duration > 240) {
        return error('La duraciÃ³n mÃ¡xima de un turno es de 4 horas.');
      }

      const datos = {
        id_tienda: parseInt(document.getElementById('tienda').value),
        hora_inicio: horaInicio,
        hora_fin: horaFin,
      };

      const res = await fetch('http://localhost:3000/api/turnos', {
        method: 'POST',
        headers: authHeaders(),
        body: JSON.stringify(datos)
      });

      const json = await res.json();
      if (json.error) {
        error(json.error);
      } else {
        ok('Turno creado correctamente');
      }
    };

    cargarDatos();
  </script>
</body>
</html>








