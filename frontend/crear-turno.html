<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Crear Turno - RRHH</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  

  <main class="container">
    <section class="hero">
      <h1 class="title">Crear Turno para una Tienda</h1>
      <p class="subtitle">Rangos de 30 minutos y máximo 8 horas.</p>
    </section>

    <div class="card">
      <form id="formTurno">
        <label for="tienda">Tienda</label>
        <select id="tienda" required></select>

        <label for="codigo">Código</label>
        <input id="codigo" maxlength="8" placeholder="Ej. A" required />

        <label for="descripcion">Descripción</label>
        <input id="descripcion" maxlength="255" placeholder="Describe el turno" required />

        <label>Hora de inicio</label>
        <div class="row" style="grid-template-columns: 120px 30px 120px; align-items:center;">
          <select id="horaInicioHora" required></select>
          <div class="muted" style="text-align:center;"> :</div>
          <select id="horaInicioMin" required>
            <option value="00">00</option>
            <option value="30">30</option>
          </select>
        </div>

        <label>Hora de fin</label>
        <div class="row" style="grid-template-columns: 120px 30px 120px; align-items:center;">
          <select id="horaFinHora" required></select>
          <div class="muted" style="text-align:center;">:</div>
          <select id="horaFinMin" required>
            <option value="00">00</option>
            <option value="30">30</option>
          </select>
        </div>

        <div class="actions">
          <button type="submit" class="btn">Crear turno</button>
        </div>
      </form>
      <p id="mensaje" class="status"></p>
    </div>
  </main>

  

  <script src="app.js"></script>
  <script>
    function decodePayload() {
      try {
        const token = localStorage.getItem('token') || '';
        if (!token || !token.includes('.')) return null;
        const b = token.split('.')[0].replace(/-/g,'+').replace(/_/g,'/');
        return JSON.parse(atob(b));
      } catch (_) { return null; }
    }
    function requireAdminOrJefe() {
      const p = decodePayload();
      const rol = String(p?.rol || '').toLowerCase();
      if (rol === 'admin' || rol === 'administrador' || rol === 'jefe') return p;
      alert('Acceso restringido: solo administradores o jefes');
      window.location.href = 'login.html';
    }
    function authHeaders() {
      const h = { 'Content-Type': 'application/json' };
      const t = localStorage.getItem('token');
      if (t) h['Authorization'] = `Bearer ${t}`;
      return h;
    }

    async function cargarDatos() {
      const me = requireAdminOrJefe();
      const tiendas = await fetch('http://localhost:3000/api/tiendas', { headers: authHeaders() }).then(r => r.json());

      const selTienda = document.getElementById('tienda');
      tiendas.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id_tienda;
        opt.textContent = t.nombre;
        selTienda.appendChild(opt);
      });
      // Si es jefe, autoseleccionar y bloquear su tienda
      if (String(me.rol).toLowerCase() === 'jefe') {
        const mine = tiendas.find(t => Number(t.id_jefe) === Number(me.uid));
        if (!mine) {
          alert('No tienes tienda asignada como jefe. Contacta con un administrador.');
        } else {
          selTienda.value = String(mine.id_tienda);
          selTienda.disabled = true;
        }
      }

      
    }

    // Rellenar horas 00..23
    const fillHours = (sel) => {
      for (let h = 0; h < 24; h++) {
        const v = String(h).padStart(2, '0');
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        sel.appendChild(opt);
      }
    };
    const hIni = document.getElementById('horaInicioHora');
    const hFin = document.getElementById('horaFinHora');
    const codigoInput = document.getElementById('codigo');
    const descripcionInput = document.getElementById('descripcion');
    fillHours(hIni); fillHours(hFin);
    if (codigoInput) {
      codigoInput.addEventListener('input', () => {
        codigoInput.value = codigoInput.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
      });
    }

    document.getElementById('formTurno').onsubmit = async (e) => {
      e.preventDefault();
      const horaInicio = `${document.getElementById('horaInicioHora').value}:${document.getElementById('horaInicioMin').value}`;
      const horaFin = `${document.getElementById('horaFinHora').value}:${document.getElementById('horaFinMin').value}`;

      const codigoInput = document.getElementById('codigo');
      const descripcionInput = document.getElementById('descripcion');
      const codigo = codigoInput ? codigoInput.value.trim().toUpperCase() : '';
      const descripcion = descripcionInput ? descripcionInput.value.trim() : '';
      if (codigoInput) codigoInput.value = codigo;


      const toMinutes = (hhmm) => {
        const [hh, mm] = String(hhmm).split(':').map(Number);
        return hh * 60 + mm;
      };
      const start = toMinutes(horaInicio);
      const end = toMinutes(horaFin);
      const isHalfHour = (m) => m % 30 === 0;

      const msgEl = document.getElementById('mensaje');
      const error = (m) => { msgEl.textContent = 'Error: ' + m; msgEl.className = 'status err'; };
      const ok = (m) => { msgEl.textContent = m; msgEl.className = 'status ok'; };

      if (!codigo) {
        return error('Debes indicar un codigo para el turno.');
      }
      if (codigo.length > 8 || !/^[A-Z0-9]+$/.test(codigo)) {
        return error('El codigo solo admite letras o numeros (maximo 8).');
      }
      if (!descripcion) {
        return error('Agrega una descripcion para el turno.');
      }

      if (!isHalfHour(start) || !isHalfHour(end)) {
        return error('Las horas deben estar en intervalos de 30 minutos.');
      }
      const duration = end - start;
      if (duration <= 0) {
        return error('La hora de fin debe ser posterior a la de inicio.');
      }
      if (duration > 480) {
        return error('La duración máxima de un turno es de 8 horas.');
      }

      const datos = {
        id_tienda: parseInt(document.getElementById('tienda').value),
        hora_inicio: horaInicio,
        hora_fin: horaFin,
        codigo,
        descripcion,
      };

      const res = await fetch('http://localhost:3000/api/turnos', {
        method: 'POST',
        headers: authHeaders(),
        body: JSON.stringify(datos)
      });

      const json = await res.json();
      if (json.error) {
        error(json.error);
      } else {
        ok('Turno creado correctamente');
      }
    };

    cargarDatos();
  </script>
</body>
</html>








