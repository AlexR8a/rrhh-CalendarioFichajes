<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Crear Turno - RRHH</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 0; background: #fff; color: #111; }
    header, footer { background: #f5f5f5; border-bottom: 1px solid #ddd; }
    footer { border-top: 1px solid #ddd; border-bottom: 0; margin-top: 24px; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 12px 16px; }
    nav a { margin-right: 10px; }
    main h1 { margin: 16px 0; font-size: 22px; }
    label { display: block; margin-top: 10px; }
    input, select, button { margin-top: 5px; padding: 8px; }
    #mensaje { margin-top: 10px; font-weight: 600; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <strong>RRHH</strong>
      <nav style="display:inline-block; margin-left:16px;">
        <a href="index.html">Inicio</a>
        <a href="ver-usuarios.html">Usuarios</a>
        <a href="ver-tiendas.html">Tiendas</a>
        <a href="asignar-turnos.html">Asignar turnos</a>
      </nav>
      <span style="float:right"><a href="login.html">Iniciar sesión</a></span>
    </div>
  </header>

  <main class="wrap">
    <h1>Crear Turno para una Tienda</h1>

  <form id="formTurno">
    <label for="tienda">Tienda:</label>
    <select id="tienda" required></select>

    <label for="id_tipo_turno">Tipo de turno:</label>
    <select name="id_tipo_turno" id="id_tipo_turno">
      <option value="">-- Ninguno --</option>
    </select>

    <label>Hora de inicio:</label>
    <div>
      <select id="horaInicioHora" required></select>
      :
      <select id="horaInicioMin" required>
        <option value="00">00</option>
        <option value="15">15</option>
        <option value="30">30</option>
        <option value="45">45</option>
      </select>
    </div>

    <label>Hora de fin:</label>
    <div>
      <select id="horaFinHora" required></select>
      :
      <select id="horaFinMin" required>
        <option value="00">00</option>
        <option value="15">15</option>
        <option value="30">30</option>
        <option value="45">45</option>
      </select>
    </div>

    <button type="submit">Crear turno</button>
  </form>

  <p id="mensaje"></p>

  </main>

  <footer>
    <div class="wrap">
      <small class="muted">© <span id="y"></span> RRHH</small>
    </div>
  </footer>

  <script>
    function requireAdmin() {
      try {
        const token = localStorage.getItem('token') || '';
        if (!token || !token.includes('.')) throw new Error('Sin token');
        const b = token.split('.')[0].replace(/-/g,'+').replace(/_/g,'/');
        const payload = JSON.parse(atob(b));
        const rol = String(payload.rol || '').toLowerCase();
        if (rol !== 'admin' && rol !== 'administrador') throw new Error('No admin');
      } catch (_) {
        alert('Acceso restringido: solo administradores');
        window.location.href = 'login.html';
      }
    }
    function authHeaders() {
      const h = { 'Content-Type': 'application/json' };
      const t = localStorage.getItem('token');
      if (t) h['Authorization'] = `Bearer ${t}`;
      return h;
    }

    async function cargarDatos() {
      requireAdmin();
      const [tiendas, tiposTurno] = await Promise.all([
        fetch('http://localhost:3000/api/tiendas', { headers: authHeaders() }).then(r => r.json()),
        fetch('http://localhost:3000/api/tipos-turno', { headers: authHeaders() }).then(r => r.json())
      ]);

      const selTienda = document.getElementById('tienda');
      tiendas.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id_tienda;
        opt.textContent = t.nombre;
        selTienda.appendChild(opt);
      });

      const select = document.getElementById('id_tipo_turno');
      tiposTurno.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id_tipo_turno;
        opt.textContent = t.nombre;
        select.appendChild(opt);
      });
    }

    // Rellenar horas 00..23
    const fillHours = (sel) => {
      for (let h = 0; h < 24; h++) {
        const v = String(h).padStart(2, '0');
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        sel.appendChild(opt);
      }
    };
    const hIni = document.getElementById('horaInicioHora');
    const hFin = document.getElementById('horaFinHora');
    fillHours(hIni); fillHours(hFin);

    document.getElementById('formTurno').onsubmit = async (e) => {
      e.preventDefault();
      const tipoSelect = document.getElementById('id_tipo_turno');
      const horaInicio = `${document.getElementById('horaInicioHora').value}:${document.getElementById('horaInicioMin').value}`;
      const horaFin = `${document.getElementById('horaFinHora').value}:${document.getElementById('horaFinMin').value}`;

      const toMinutes = (hhmm) => {
        const [hh, mm] = String(hhmm).split(':').map(Number);
        return hh * 60 + mm;
      };
      const start = toMinutes(horaInicio);
      const end = toMinutes(horaFin);
      const isQuarter = (m) => m % 15 === 0;

      const msgEl = document.getElementById('mensaje');
      const error = (m) => { msgEl.textContent = 'Error: ' + m; msgEl.style.color = 'red'; };
      const ok = (m) => { msgEl.textContent = m; msgEl.style.color = 'green'; };

      if (!isQuarter(start) || !isQuarter(end)) {
        return error('Las horas deben estar en intervalos de 15 minutos.');
      }
      const duration = end - start;
      if (duration <= 0) {
        return error('La hora de fin debe ser posterior a la de inicio.');
      }
      if (duration > 240) {
        return error('La duración máxima de un turno es de 4 horas.');
      }

      const datos = {
        id_tienda: parseInt(document.getElementById('tienda').value),
        id_tipo_turno: tipoSelect.value ? parseInt(tipoSelect.value) : undefined,
        hora_inicio: horaInicio,
        hora_fin: horaFin,
      };

      const res = await fetch('http://localhost:3000/api/turnos', {
        method: 'POST',
        headers: authHeaders(),
        body: JSON.stringify(datos)
      });

      const json = await res.json();
      if (json.error) {
        error(json.error);
      } else {
        ok('Turno creado correctamente');
      }
    };

    document.getElementById('y').textContent = new Date().getFullYear();
    cargarDatos();
  </script>
</body>
</html>
